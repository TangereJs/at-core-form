

<link rel="import" href="../paper-input/paper-input.html" />
<link rel="import" href="../paper-checkbox/paper-checkbox.html" />
<link rel="import" href="../at-form-lookup/at-form-lookup.html" />

<polymer-element name="at-core-form" attributes="schema data">
  <template>
    <div id="insertPoint">
      <div>
        <h3>This is at-core-form demo</h3>
      </div>
    </div>
    <content></content>
  </template>

  <script>
    Polymer('at-core-form', {
      publish: {
        schema: {},
        data: {},
        valid: true
      },
      dataBindingObject: {}, // this object will be used to bind values to form elements; when this.data changes dataBindingObject will be updated and form element values will be udpated automatically
      ready: function () { },
      clear: function () {
        var myNode = this.$.insertPoint;
        while (myNode.firstChild) {
          myNode.removeChild(myNode.firstChild);
        }
      },
      schemaChanged: function (oldValue, newValue) {
        var self = this;

        this.schema = newValue;
        this.clear();
        var properties = this.schema.properties;
        for (property in properties) {
          var propertyDefinition = properties[property];

          var description = notNullOrUndefined(propertyDefinition.description) ? propertyDefinition.description : property;
          var type = propertyDefinition.type;
          var required = propertyDefinition.required === "true" || (this.schema.required && this.schema.required.indexOf(property) !== -1);
          // handle the input mode functionality
          var inputMode = 'optional';
          if (propertyDefinition.inputmode === undefined && required === true ){
            inputMode = 'required';
          } else {
            inputMode = propertyDefinition.inputmode !== undefined && propertyDefinition.inputmode !== ''? propertyDefinition.inputmode : inputMode;
          }

          // get the default value and regular value
          var defaultValue = propertyDefinition.default;
          var value = this.data[property];
          // if default value is not null or undefined and regular value is null or undefined
          if (notNullOrUndefined(defaultValue) && !notNullOrUndefined(value)) {
            // make the default value regular value
            this.data[property] = defaultValue;
          }

          if (this.dataBindingObject[property] === undefined) {
            this.dataBindingObject[property] = "";
          }

          var paperElement = undefined;
          var divElem = document.createElement('div');

          if (notNullUndefinedOrEmpty(type)) {
            switch (type) {
              case "string":
              case "number":
                // create paper-input
                paperElement = document.createElement('paper-input-decorator');
                var coreInput = document.createElement('input');
                coreInput.setAttribute('is', 'core-input');

                if (inputMode === 'required') {
                  coreInput.setAttribute('required', true);
                  paperElement.setAttribute('error', 'This input requires a value!');
                } else {
                  coreInput.setAttribute(inputMode, true);
                }

                if (type === "number") {
                  coreInput.setAttribute('type', type);
                  paperElement.setAttribute('error', 'Please enter a number!');
                }
                paperElement.appendChild(coreInput);

                coreInput.addEventListener('change', function (e) {
                  var isValid = e.target.checkValidity();
                  e.target.parentElement.isInvalid = !isValid;
                  self.valid = self.valid && isValid;
                });

                paperElement.id = property;
                paperElement.name = property;
                paperElement.bind('label', new PathObserver({ label: description }, 'label'));
                paperElement.floatingLabel = true;

                coreInput.bind('value', new PathObserver(this.dataBindingObject, property));
                divElem.appendChild(paperElement);
                paperElement.addEventListener('change', function (e) {
                  self.fire('data-changed', self.dataBindingObject);
                });
                break;
              case "boolean":
                // create paper-checkbox
                paperElement = document.createElement('paper-checkbox');
                paperElement.id = property;
                paperElement.name = property;
                paperElement.bind('label', new PathObserver({ label: description }, 'label'));
                paperElement.bind('checked', new PathObserver(this.dataBindingObject, property));
                divElem.appendChild(paperElement);
                paperElement.addEventListener('core-change', function (e) {
                  self.fire('data-changed', self.dataBindingObject);
                });
                break;
              case "enum":
                paperElement = document.createElement('at-form-lookup');
                paperElement.id = property;
                paperElement.name = property;
                paperElement.value = defaultValue;
                paperElement.available = propertyDefinition['available'];
                paperElement.setAttribute('usedropdown', true);
                divElem.appendChild(paperElement);
                paperElement.bind('value', new PathObserver(this.dataBindingObject, property));
                paperElement.addEventListener('change', function (e) {
                  var isValid = e.target.checkValidity();
                  self.valid = self.valid && isValid;

                  self.fire('data-changed', self.dataBindingObject);
                });
                break;
              case "lookup":
                paperElement = document.createElement('at-form-lookup');
                paperElement.id = property;
                paperElement.name = property;
                //paperElement.value = defaultValue;
                paperElement.url = propertyDefinition['url'];
                paperElement.setAttribute('usedropdown', true);
                if (propertyDefinition['withCredentials'] !== undefined) {
                  paperElement.setAttribute('withCredentials', true);
                }
                divElem.appendChild(paperElement);
                paperElement.bind('value', new PathObserver(this.dataBindingObject, property));
                paperElement.addEventListener('change', function (e) {
                  //var isValid = e.target.checkValidity();
                  //self.valid = self.valid && isValid;

                  self.fire('data-changed', self.dataBindingObject);
                });
                break;
                break;
            }
            this.$.insertPoint.appendChild(divElem);
          } else {
            console.log("Property " + property + " doens't have defined type. Skipping ...");
          }
        }
      },
      dataChanged: function (oldValue, newValue) {
        for (entry in newValue) {
          this.dataBindingObject[entry] = newValue[entry];
        }
      }
    });

    function notNullOrUndefined(param) {
      return (param !== null) && (param !== undefined)
    }

    function notNullUndefinedOrEmpty(param) {
      return notNullOrUndefined(param) && (param !== '');
    }
  </script>
</polymer-element>
