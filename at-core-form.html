

<link rel="import" href="../paper-input/paper-input.html" />
<link rel="import" href="../paper-checkbox/paper-checkbox.html" />
<link rel="import" href="../at-form-lookup/at-form-lookup.html" />

<polymer-element name="at-core-form" attributes="schema data">
  <template>
    <div id="insertPoint">
      <div>
        <h3>This is at-core-form demo</h3>
      </div>
    </div>
    <content></content>
  </template>

  <script>
    Polymer('at-core-form', {
      publish: {
        schema: {},
        data: {},
      },
      ready: function () { },
      clear: function () {
        var myNode = this.$.insertPoint;
        while (myNode.firstChild) {
          myNode.removeChild(myNode.firstChild);
        }
      },
      schemaChanged: function (oldValue, newValue) {
        this.schema = newValue;
        this.clear();
        var properties = this.schema.properties;
        for (property in properties) {
          var propertyDefinition = properties[property];

          var description = notNullOrUndefined(propertyDefinition.description) ? propertyDefinition.description : property;
          var type = propertyDefinition.type;
          var required = propertyDefinition.required || (this.schema.required && this.schema.required.indexOf(property) !== -1);
          // get the default value and regular value
          var defaultValue = propertyDefinition.default;
          var value = this.data[property];
          // if default value is not null or undefined and regular value is null or undefined
          if (notNullOrUndefined(defaultValue) && !notNullOrUndefined(value)) {
            // make the default value regular value
            this.data[property] = defaultValue;
          }

          var paperElement = undefined;
          var divElem = document.createElement('div');

          if (notNullUndefinedOrEmpty(type)) {
            switch (type) {
              case "string":
              case "number":
                // create paper-input
                paperElement = document.createElement('paper-input-decorator');
                var coreInput = document.createElement('input');
                coreInput.setAttribute('is', 'core-input');
                if (required) {
                  coreInput.setAttribute('required', '');
                  paperElement.setAttribute('error', 'This input requires a value!');
                }
                if (type === "number") {
                  coreInput.setAttribute('type', type);
                  paperElement.setAttribute('error', 'Please enter a number!');
                }
                paperElement.appendChild(coreInput);

                coreInput.oninput = function (e) {
                  e.target.parentElement.isInvalid = !e.target.checkValidity();
                }

                paperElement.id = property;
                paperElement.name = property;
                paperElement.bind('label', new PathObserver({ label: description }, 'label'));
                paperElement.floatingLabel = true;
                if (value != undefined) { // if value exists set it as default; if it doesn't do nothing
                  coreInput.bind('value', new PathObserver({ value: value.toString() }, 'value'));
                }
                divElem.appendChild(paperElement);
                //this.$.insertPoint.appendChild(divElem);
                break;
              case "boolean":
                // create paper-checkbox
                paperElement = document.createElement('paper-checkbox');
                paperElement.id = property;
                paperElement.name = property;
                paperElement.bind('label', new PathObserver({ label: description }, 'label'));
                paperElement.bind('checked', new PathObserver({ value: value }, 'value'));
                divElem.appendChild(paperElement);
                break;
              case "enum":
                paperElement = document.createElement('at-form-lookup');
                paperElement.id = property;
                paperElement.name = property;
                paperElement.value = defaultValue;
                paperElement.available = propertyDefinition['available'];
                paperElement.setAttribute('usedropdown', true);
                divElem.appendChild(paperElement);
                break;
            }
            this.$.insertPoint.appendChild(divElem);
          } else {
            console.log("Property " + property + " doens't have defined type. Skipping ...");
          }
        }
      },
      dataChanged: function (oldValue, newValue) {
        this.data = newValue;
        for (dataEntry in this.data) {
          var element = this.shadowRoot.querySelector('*[id=\'' + dataEntry + '\']');
          var value = this.data[dataEntry];
          if (notNullOrUndefined(value)) {
            element.bind('value', new PathObserver({ value: value.toString() }, 'value'));
          }
        }
      }
    });

    function notNullOrUndefined(param) {
      return (param !== null) && (param !== undefined)
    }

    function notNullUndefinedOrEmpty(param) {
      return notNullOrUndefined(param) && (param !== '');
    }
  </script>
</polymer-element>
