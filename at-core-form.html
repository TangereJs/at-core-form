<link rel="import" href="../at-form-input/at-form-input.html" />
<link rel="import" href="../at-form-checkbox/at-form-checkbox.html" />
<link rel="import" href="../at-form-lookup/at-form-lookup.html" />
<!--<link rel="import" href="../at-form-toggle/at-form-toggle.html" />-->
<!--<link rel="import" href="../at-form-markdown/at-form-markdown.html" />-->
<!--<link rel="import" href="../at-form-codemirror/at-form-codemirror.html" />-->

<dom-module id="at-core-form">
  <template>
    <div id="insertPoint"></div>
    <content></content>
  </template>
</dom-module>

<script>
  "use strict";
  Polymer({
    is: 'at-core-form',
    properties: {
      schema: {
        type: Object,
        value: {},
        observer: 'schemaChanged'
      },
      data: {
        type: Object,
        value: {},
        notify: true,
        observer: 'dataChanged'
      },
      invalid: {
        type: Boolean,
        notify: true,
        value: false
      },
      disabled: {
        type: Boolean,
        notify: true,
        value: false
      }
    },
    _isReady: false,
    ready: function () {
      this.elementsToValidate = [];
      this._isReady = true;
      this.schemaChanged(this.schema, this.schema);
      this.dataChanged(this.data, this.data);
    },
    clear: function () {
      var myNode = this.$.insertPoint;
      while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
      }
    },
    elementsToValidate: [],
    schemaChanged: function (oldValue, newValue) {
      if (this._isReady) {
        var self = this;
        self.elementsToValidate = [];

        //      this.schema = newValue;
        this.clear();
        var properties = this.schema.properties;
        var codeMode = 'htmlmixed';
        for (var property in properties) {
          var propertyDefinition = properties[property];

          var description = notNullOrUndefined(propertyDefinition.description) ? propertyDefinition.description : property;
          var type = propertyDefinition.type;
          if (type === "string" && propertyDefinition.xtype !== undefined && propertyDefinition.xtype !== null && propertyDefinition.xtype !== "") {
            type = propertyDefinition.xtype;
            if (type.indexOf('-') != -1) {
              var startIndex = type.indexOf('-');
              codeMode = type.substring(startIndex + 1);
              type = type.substring(0, startIndex);

              // mappings for code-* are
              // code-html -> htmlmixed
              // code-css -> text/css
              // code-javascript -> javascript
              // code-json -> application/json
              // code-sql -> sql
              // code-xml -> xml
              switch (codeMode) {
              case "html":
                codeMode = 'htmlmixed';
                break;
              case "css":
                codeMode = 'text/css';
                break;
              case "javascript":
                codeMode = 'javascript';
                break;
              case "json":
                codeMode = 'application/json';
                break;
              case "sql":
                codeMode = 'sql';
                break;
              case "xml":
                codeMode = 'xml';
                break;
              }
            }
          }
          var required = propertyDefinition.required === "true" || (this.schema.required && this.schema.required.indexOf(property) !== -1);
          // handle the input mode functionality
          var inputMode = 'optional';
          if (propertyDefinition.xinputmode === undefined && required === true) {
            inputMode = 'required';
          } else {
            inputMode = propertyDefinition.xinputmode !== undefined && propertyDefinition.xinputmode !== '' ? propertyDefinition.xinputmode : inputMode;
          }

          // get the default value and regular value
          var defaultValue = propertyDefinition.default;
          var value = this.data[property];
          // if default value is not null or undefined and regular value is null or undefined
          if (notNullOrUndefined(defaultValue) && !notNullOrUndefined(value)) {
            // make the default value regular value
            this.data[property] = defaultValue;
          }

          var disabledValue = propertyDefinition.disabled !== undefined ? propertyDefinition.disabled : false;
          if (disabledValue === "true") {
            disabledValue = true;
          }
          if (disabledValue === "false") {
            disabledValue = false;
          }

          var paperElement = undefined;
          var divElem = document.createElement('div');

          if (notNullUndefinedOrEmpty(type)) {
            switch (type) {
            case "code":
              paperElement = document.createElement('at-form-codemirror');

              if (inputMode === 'required') {
                paperElement.setAttribute('required', true);
                this.elementsToValidate.push(coreInput);
              } else {
                paperElement.setAttribute(inputMode, true);
              }

              paperElement.addEventListener('value-changed', function (event) {
                self.data[property] = event.detail.value;
                self.updateValidState();
                this.fire('data-updated', self.data);
              });

              paperElement.id = property;
              paperElement.name = property;
              paperElement.label = description;
              paperElement.mode = codeMode;
              paperElement.value = this.data[property] ? this.data[property] : '';

              divElem.appendChild(paperElement);
              divElem.style.height = '100px';
              paperElement.style.height = '100%';
              break;
            case "number":
            case "string":
              // create paper-input
              paperElement = document.createElement('at-form-input');

              if (inputMode === 'required') {
                paperElement.required = true;
                this.elementsToValidate.push(paperElement);
              } else {
                paperElement.setAttribute(inputMode, true);
              }

              if (type === "number") {
                paperElement.type = type;
                // paperElement.setAttribute('error', 'Please enter a number!');
              }

              paperElement.addEventListener('value-changed', function (e) {
                self.data[e.target.name] = e.detail.value;
                self.updateValidState();
                this.fire('data-updated', self.data);
              });

              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              paperElement.label = description;
              paperElement.disabled = disabledValue;
              paperElement.value = this.data[property] ? this.data[property] : '';

              divElem.appendChild(paperElement);
              break;
            case "bool":
            case "boolean":
              // create paper-checkbox
              if (propertyDefinition['xtype'] === 'toggle') {
                paperElement = document.createElement('at-form-toggle');
              } else {
                paperElement = document.createElement('at-form-checkbox');
              }

              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              if (disabledValue === true) {
                paperElement.setAttribute('disabled', disabledValue);
              }
              paperElement.label = description;
              paperElement.addEventListener('value-changed', function (e) {
                self.data[e.target.name] = e.detail.value;
                this.fire('data-updated', self.data);
              });
              paperElement.value = this.data[property] ? this.data[property] : '';

              divElem.appendChild(paperElement);
              break;
            case "enum":
              paperElement = document.createElement('at-form-lookup');
              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              paperElement.setAttribute('disabled', disabledValue);
              paperElement.label = description;
              paperElement.available = propertyDefinition['xvaluelist'];
              paperElement.value = this.data[property] ? this.data[property] : '';
              divElem.appendChild(paperElement);
              paperElement.addEventListener('value-changed', function (e) {
                self.data[e.target.name] = e.detail.value;
                self.updateValidState();
                this.fire('data-updated', self.data);
              });
              this.elementsToValidate.push(paperElement);
              break;
            case "lookup":
              paperElement = document.createElement('at-form-lookup');
              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              paperElement.label = description;
              paperElement.setAttribute('disabled', disabledValue);
              paperElement.url = propertyDefinition['xurl'];
              if (paperElement.url !== undefined) {
                //paperElement.setAttribute('preload', true);
                paperElement.setAttribute('params', '{"query":""}');
              }
              paperElement.value = this.data[property] ? this.data[property] : '';

              //paperElement.setAttribute('usedropdown', true);
              if (propertyDefinition['noCredentials'] !== undefined) {
                paperElement.setAttribute('noCredentials', true);
              }
              divElem.appendChild(paperElement);
              paperElement.addEventListener('value-changed', function (e) {
                self.data[e.target.name] = e.detail.value;
                self.updateValidState();
                this.fire('data-updated', self.data);
              });
              break;
            case "marked":
              paperElement = document.createElement('at-form-markdown');
              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              paperElement.label = description;
              paperElement.value = this.data[property] ? this.data[property] : '';
              if (disabledValue === true) {
                paperElement.setAttribute('disabled', disabledValue);
              }

              divElem.appendChild(paperElement);
              paperElement.addEventListener('value-changed', function (e) {
                self.data[e.target.name] = e.detail.value;
                self.updateValidState();
                this.fire('data-updated', self.data);
              });
              break;
            }
            this.$.insertPoint.appendChild(divElem);
          } else {
            console.log("Property " + property + " doens't have defined type. Skipping ...");
          }
        }
      }
    },
    dataChanged: function (oldValue, newValue) {
      for (var entry in this.data) {
        var element = Polymer.dom(this.$.insertPoint).querySelector('#' + entry);
        if (element) {
          element.value = this.data[entry];
        }
      }
    },
    updateValidState: function () {
      var closureThis = this;
      setTimeout(function () {
        var isInvalid = false;
        //console.clear();
        for (var i = 0; i < closureThis.elementsToValidate.length; i++) {
          var element = closureThis.elementsToValidate[i];
          if (element.invalid !== undefined) {
            var invalid = element.invalid;
            isInvalid = isInvalid || invalid;
            //console.log("Element " + element.name + " is " + isValid);
          }
        }
        closureThis.invalid = isInvalid;
      }, 100);
    },
    disabledChanged: function () {
      for (var property in this.schema.properties) {
        var element = this.$.insertPoint.querySelector('.' + property);
        var disabledValue = this.disabled;
        if (this.disabled === false) {
          var elemDisabledValue = this.schema.properties[element.id].disabled;
          if (elemDisabledValue !== undefined && (elemDisabledValue === "true" || elemDisabledValue === true)) {
            disabledValue = true;
          }
        }
        element.setAttribute('disabled', disabledValue);
        var childInput = element.querySelector('input');
        if (notNullOrUndefined(childInput)) {
          if (disabledValue === false) {
            childInput.removeAttribute('disabled');
          } else {
            childInput.setAttribute('disabled', true);
          }
        }
      }
    },
  });

  function notNullOrUndefined(param) {
    return (param !== null) && (param !== undefined)
  }

  function notNullUndefinedOrEmpty(param) {
    return notNullOrUndefined(param) && (param !== '');
  }

  function isObject(obj) {
    return Object.prototype.toString.call(obj) === Object.prototype.toString.call({});
  }

  function copyPropertyValues(from, to) {
    if (isObject(from) && isObject(to)) {
      for (var property in from) {
        to[property] = from[property];
      }
    }
  }
</script>