<link rel="import" href="../at-form-input/at-form-input.html" />
<link rel="import" href="../at-form-checkbox/at-form-checkbox.html" />
<link rel="import" href="../at-form-lookup/at-form-lookup.html" />
<!--<link rel="import" href="../at-form-toggle/at-form-toggle.html" />-->
<link rel="import" href="../at-form-markdown/at-form-markdown.html" />
<link rel="import" href="../at-form-codemirror/at-form-codemirror.html" />

<dom-module id="at-core-form">
  <template>
    <div id="insertPoint" class="ui form"></div>
    <content></content>
  </template>
</dom-module>

<script>
  "use strict";
  Polymer({
    is: 'at-core-form',
    properties: {
      schema: {
        type: Object,
        value: {},
        observer: 'schemaChanged'
      },
      data: {
        type: Object,
        value: {},
        notify: true,
        observer: 'dataChanged'
      },
      valid: {
        type: Boolean,
        notify: true,
        value: true,
        readOnly: true
      },
      disabled: {
        type: Boolean,
        notify: true,
        value: false
      }
    },
    _isReady: false,
    ready: function () {
      this.elementsToValidate = [];
      this._isReady = true;
      this.schemaChanged(this.schema, this.schema);
      this.dataChanged(this.data, this.data);
    },
    clear: function () {
      var myNode = this.$.insertPoint;
      while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
      }
    },
    elementsToValidate: [],
    schemaChanged: function (oldValue, newValue) {
      if (this._isReady) {
        var self = this;
        self.elementsToValidate = [];

        //      this.schema = newValue;
        this.clear();
        var properties = this.schema.properties;
        var codeMode = 'htmlmixed';
        for (var property in properties) {
          var propertyDefinition = properties[property];

          var description = property;
          if (notNullOrUndefined(propertyDefinition.description)) {
            description = propertyDefinition.description;
          } else if (notNullOrUndefined(propertyDefinition.title)) {
            description = propertyDefinition.title;
          }

          var type = propertyDefinition.type;
          if (type === "string" && propertyDefinition.xtype !== undefined && propertyDefinition.xtype !== null && propertyDefinition.xtype !== "") {
            type = propertyDefinition.xtype;
            if (type.indexOf('-') != -1) {
              var startIndex = type.indexOf('-');
              codeMode = type.substring(startIndex + 1);
              type = type.substring(0, startIndex);

              // mappings for code-* are
              // code-html -> htmlmixed
              // code-css -> text/css
              // code-javascript -> javascript
              // code-json -> application/json
              // code-sql -> sql
              // code-xml -> xml
              switch (codeMode) {
              case "html":
                codeMode = 'htmlmixed';
                break;
              case "css":
                codeMode = 'text/css';
                break;
              case "javascript":
                codeMode = 'javascript';
                break;
              case "json":
                codeMode = 'application/json';
                break;
              case "sql":
                codeMode = 'sql';
                break;
              case "xml":
                codeMode = 'xml';
                break;
              }
            }
          }
          var required = propertyDefinition.required === "true" || (this.schema.required && this.schema.required.indexOf(property) !== -1);

          // get the default value and regular value
          var defaultValue = propertyDefinition.default;
          var value = this.data[property];
          // if default value is not null or undefined and regular value is null or undefined
          if (notNullOrUndefined(defaultValue) && !notNullOrUndefined(value)) {
            // make the default value regular value
            this.data[property] = defaultValue;
          }

          var disabledValue = propertyDefinition.disabled !== undefined ? propertyDefinition.disabled : false;
          if (disabledValue === "true") {
            disabledValue = true;
          }
          if (disabledValue === "false") {
            disabledValue = false;
          }

          var paperElement = undefined;
          var divElem = document.createElement('div');
          divElem.classList.add('field');

          if (notNullUndefinedOrEmpty(type)) {
            switch (type) {
            case "code":
              paperElement = document.createElement('at-form-codemirror');

              paperElement.required = required;
              if (required) {
                this.elementsToValidate.push(paperElement);
              }

              paperElement.addEventListener('value-changed', function (event) {
                self._updateDataObject(event.target.name, event.detail.value);
              });

              paperElement.id = property;
              paperElement.name = property;
              paperElement.label = description;
              paperElement.mode = codeMode;
              paperElement.value = this.data[property] ? this.data[property] : '';

              divElem.appendChild(paperElement);
              //              divElem.style.height = '100px';
              //              paperElement.style.height = '100%';
              break;
            case "number":
            case "string":
              // create paper-input
              paperElement = document.createElement('at-form-input');

              paperElement.required = required;
              if (required) {
                this.elementsToValidate.push(paperElement);
              }

              if (type === "number") {
                paperElement.type = type;
                // paperElement.setAttribute('error', 'Please enter a number!');
              }

              paperElement.addEventListener('value-changed', function (event) {
                self._updateDataObject(event.target.name, event.detail.value);
              });

              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              paperElement.label = description;
              paperElement.disabled = disabledValue;
              paperElement.value = this.data[property] ? this.data[property] : '';

              divElem.appendChild(paperElement);
              break;
            case "bool":
            case "boolean":
              // create at-form-checkbox
              paperElement = document.createElement('at-form-checkbox');
              if (propertyDefinition['xtype'] === 'toggle') {
                paperElement.toggle = true;
              }

              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              if (disabledValue === true) {
                paperElement.setAttribute('disabled', disabledValue);
              }
              paperElement.label = description;
              paperElement.addEventListener('value-changed', function (event) {
                self._updateDataObject(event.target.name, event.detail.value);
              });
              paperElement.value = this.data[property] ? this.data[property] : '';

              divElem.appendChild(paperElement);
              break;
            case "enum":
              paperElement = document.createElement('at-form-lookup');
              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              paperElement.disabled = disabledValue;
              paperElement.label = description;
              paperElement.available = propertyDefinition['xvaluelist'];
              paperElement.value = this.data[property] ? this.data[property] : '';
              divElem.appendChild(paperElement);
              paperElement.addEventListener('value-changed', function (event) {
                self._updateDataObject(event.target.name, event.detail.value);
              });

              paperElement.required = required;
              if (required) {
                this.elementsToValidate.push(paperElement);
              }

              break;
            case "lookup":
              paperElement = document.createElement('at-form-lookup');
              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              paperElement.label = description;
              paperElement.required = required;
              if (required) {
                this.elementsToValidate.push(paperElement);
              }
              if (disabledValue) {
                paperElement.setAttribute('disabled', disabledValue);
              }
              paperElement.url = propertyDefinition['xurl'];
              if (paperElement.url !== undefined) {
                //paperElement.setAttribute('preload', true);
                paperElement.setAttribute('params', '{"query":""}');
              }
              paperElement.value = this.data[property] ? this.data[property] : '';

              //paperElement.setAttribute('usedropdown', true);
              if (propertyDefinition['noCredentials'] !== undefined) {
                paperElement.setAttribute('noCredentials', true);
              }
              divElem.appendChild(paperElement);
              paperElement.addEventListener('value-changed', function (event) {
                self._updateDataObject(event.target.name, event.detail.value);
              });
              break;
            case "marked":
              paperElement = document.createElement('at-form-markdown');
              paperElement.id = property;
              paperElement.name = property;
              paperElement.classList.add(property);
              paperElement.label = description;
              paperElement.required = required;
              if (required) {
                this.elementsToValidate.push(paperElement);
              }

              paperElement.value = this.data[property] ? this.data[property] : '';
              if (disabledValue === true) {
                paperElement.setAttribute('disabled', disabledValue);
              }

              divElem.appendChild(paperElement);
              paperElement.addEventListener('value-changed', function (event) {
                self._updateDataObject(event.target.name, event.detail.value);
              });
              break;
            }
            this.$.insertPoint.appendChild(divElem);
          } else {
            console.log("Property " + property + " doens't have defined type. Skipping ...");
          }
        }
      }
    },
    dataChanged: function (oldValue, newValue) {
      for (var entry in this.data) {
        var element = Polymer.dom(this.$.insertPoint).querySelector('#' + entry);
        if (element) {
          element.value = this.data[entry];
        }
      }
      this.validate();
    },

    /*
     * This function is called on value-changed event for each element on the form
     * property is property name
     * value is the new value to be set
     */
    _updateDataObject: function (property, value) {
      this.data[property] = value;
      this.validate();
      this.fire('data-changed', {
        value: this.data
      });
    },

    /*
     * Validates the form
     * It calls validate method of each element in elementsToValidate array
     * Form is valid if all elements are valid. Form is invalid if at least one element is invalid.
     */
    validate: function () {
      var isValid = true;

      for (var i = 0; i < this.elementsToValidate.length; i++) {
        var element = this.elementsToValidate[i];
        if (isFunction(element.validate)) {
          var elementValid = element.validate();
          isValid = isValid && elementValid;
        }
      }

      this._setValid(isValid);

      return isValid;
    },
    disabledChanged: function () {
      for (var property in this.schema.properties) {
        var element = this.$.insertPoint.querySelector('.' + property);
        var disabledValue = this.disabled;
        if (this.disabled === false) {
          var elemDisabledValue = this.schema.properties[element.id].disabled;
          if (elemDisabledValue !== undefined && (elemDisabledValue === "true" || elemDisabledValue === true)) {
            disabledValue = true;
          }
        }
        element.setAttribute('disabled', disabledValue);
        var childInput = element.querySelector('input');
        if (notNullOrUndefined(childInput)) {
          if (disabledValue === false) {
            childInput.removeAttribute('disabled');
          } else {
            childInput.setAttribute('disabled', true);
          }
        }
      }
    },
  });

  function isFunction(obj) {
    return Object.prototype.toString.apply(obj) === Object.prototype.toString.apply(function () {});
  }

  function notNullOrUndefined(param) {
    return (param !== null) && (param !== undefined)
  }

  function notNullUndefinedOrEmpty(param) {
    return notNullOrUndefined(param) && (param !== '');
  }

  function isObject(obj) {
    return Object.prototype.toString.call(obj) === Object.prototype.toString.call({});
  }

  function copyPropertyValues(from, to) {
    if (isObject(from) && isObject(to)) {
      for (var property in from) {
        to[property] = from[property];
      }
    }
  }
</script>
</script>