<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>At-Core-Form demo</title>

  <script src="../webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="../polymer/polymer.html" />
  <link rel="import" href="../code-mirror/code-mirror.html" />
  <link rel="import" href="../layout/layout.html" />
  <link rel="import" href="at-core-form.html" />

  <style>
    body {
      margin: 0;
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
    }
    
    .h100w100 {
      height: 100%;
      width: 100%;
    }
    
    .h100w50 {
      height: 100%;
      width: 50%;
    }
    
    .h50w100 {
      height: 50%;
      width: 100%;
    }
    
    code-mirror {
      height: inherit;
      width: inherit;
    }
  </style>
</head>

<body>
  <div class="horizontal layout h100w100">
    <div class="flex h100w50">
      <div class="vertical layout h100w100">
        <h2>Form Schema (JSON)</h2>
        <!--setting mode to json or json-ld doesn't work so I use javascript which works-->
        <!--// mappings for code-* are
          // code-html -> htmlmixed
          // code-css -> text/css
          // code-javascript -> javascript
          // code-json -> application/json
          // code-sql -> sql
          // code-xml -> xml-->
        <code-mirror id="formSchema" mode="javascript" class="h100w100">
          { 
            "properties": { 
              "id": { 
                "description": "The unique identifier for a product", 
                "type": "number"
              }, 
              "name": { 
                "type": "string", 
                "required": "true", 
                "xinputmode": "required" 
              }, 
              "city": { 
                "type": "string", 
                "default": "Default city name" 
              }, 
              "active": { 
                "type": "boolean" 
              }, 
              "activePera": { 
                "type": "boolean", 
                "description": "This is description for pera" 
              }, 
              "activeToggle": { 
                "type": "boolean", 
                "xtype": "toggle", 
                "description": "This is description for active toggle" 
              }, 
              "dropdownDemo": { 
                "title": "Name", 
                "type": "string", 
                "xtype": "enum", 
                "xvaluelist":"XML,JSON", 
                "default": "XML" 
              }, 
              "card": { 
                "title": "Card", 
                "type": "string", 
                "xtype": "lookup", 
                "xurl": "http://localhost:2014/Activity/adenin.GateKeeper.Content/card/"
              }, 
              "codeMirrorDemo": { 
                "title": "Code Mirror", 
                "type": "string", 
                "xtype": "code-markdown"
              }, 
              "markdownDemo": { 
                "title": "Markdown", 
                "type": "string", 
                "xtype": "marked"
              }
            }, 
            "required": ["id", "city"] 
          }
        </code-mirror>
      </div>
    </div>
    <div class="flex h100w50">
      <div class="vertical layout h100w100">
        <h2>Form Data (JSON)</h2>
        <div>
          <label>Form is currently: </label>
          <span id="formValid">valid</span>
          <span id="formInvalid" hidden>invalid</span>
        </div>
        <!--setting mode to json or json-ld doesn't work so I use javascript which works -->
        <code-mirror id="formData" mode="javascript" class="h100w100">
          { 
            "id": "5", 
            "city": "Boston", 
            "active": true, 
            "activePera": false 
          }
        </code-mirror>
      </div>
    </div>
    <div class="flex">
      <div class="vertical layout">
        <h2>Generated form</h2>
        <at-core-form id="coreForm" class="flex">
        </at-core-form>
      </div>
    </div>
  </div>

  <script>
    (function () {

      window.addEventListener('WebComponentsReady', function (e) {
        var coreForm = document.getElementById('coreForm');

        var formSchema = document.getElementById('formSchema');
        formSchema.mirror.on('change', function () {
          //console.log("form schema changed");
          try {
            coreForm.schema = JSON.parse(formSchema.mirror.getValue());
            coreForm.updateValidState();
          } catch (e) {

          }

        });
        //autoFormat(formSchema.mirror);

        var formData = document.getElementById('formData');
        formData.mirror.on('change', function () {
          //console.log("form data changed");
          try {
            coreForm.data = JSON.parse(formData.mirror.getValue());
            coreForm.updateValidState();
          } catch (e) {

          }
        });
        //autoFormat(formData.mirror);

        try {
          var schema = JSON.parse(formSchema.mirror.getValue());
          coreForm.schema = schema;
          var data = JSON.parse(formData.mirror.getValue());
          coreForm.data = data;
          coreForm.addEventListener('data-updated', function (e) {
            var dataString = JSON.stringify(e.detail);
            dataString = dataString.replace(/,/g, ",\n");
            formData.value = dataString;
          });

          updateFormValidGui(!coreForm.invalid);
        } catch (e) {

        }

        var validObject = {
          valid: true
        };
        coreForm.addEventListener('invalid-changed', function (e) {
          validObject.valid = !e.detail.value;
          updateFormValidGui(validObject.valid);
        });
      });

      var formValidSpan = document.getElementById("formValid");
      var formInvalidSpan = document.getElementById("formInvalid");

      function updateFormValidGui(valid) {
        if (valid) {
          formValidSpan.removeAttribute('hidden');
          formInvalidSpan.setAttribute('hidden', true);
        } else {
          formValidSpan.setAttribute('hidden', true);
          formInvalidSpan.removeAttribute('hidden');
        }
      }

      function autoFormat(editor) {
        // this doesn't work because polymer code mirror doesn't support code formatting :'(
        //var totalLines = editor.lineCount();
        //var totalChars = editor.getValue().length;
        //editor.autoFormatRange({ line: 0, ch: 0 }, { line: totalLines, ch: totalChars });
      }
    })();
  </script>
</body>

</html>